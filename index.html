<!DOCTYPE html>
<html>
<head>
    <script src="./phaser.js"></script>
</head>
<body>

    <script>
    let config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        backgroundColor: "#fff",
        physics: {
            default: "arcade",
            arcade: {
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    let game = new Phaser.Game(config);

    function preload() {
        this.load.spritesheet("tank", "./sprites/tank-sprite.png", {frameWidth: 26, frameHeight: 32});
        this.load.image("block", "./sprites/black_block.png");
        this.load.image("enemy", "./sprites/enemy.png");
        this.load.image("fireball", "./sprites/fireball.png");
    }

    let walls;
    let tank;
    let move;
    let spacebar;
    let moveSpeed = 100;
    let fireSpeed = 300;

    function create() {
        tank = this.physics.add.sprite(400, 300, "tank");
        enemies = this.physics.add.group({
            key: "enemy",
            repeat: 5,
            setXY: {x: 100, y: 400, stepX: 50}
        });
        move = this.input.keyboard.createCursorKeys();
        spacebar = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

        walls = this.physics.add.staticGroup();
        walls.create(16, 16, "block");
        walls.create(48, 16, "block");
        walls.create(16, 48, "block");
        walls.create(100, 100, "block").setScale(2).refreshBody();
        walls.create(132, 132, "block");
        walls.create(164, 164, "block");
        walls.create(200, 200, "block");
        walls.create(232, 200, "block");
        walls.create(264, 200, "block");

        this.physics.add.collider(tank, walls);
        this.physics.add.collider(enemies, walls);
        this.physics.add.collider(enemies, enemies);
        this.physics.add.collider(tank, enemies);

        this.anims.create({
            key: 'move',
            frames: this.anims.generateFrameNumbers('tank', { start: 0, end: 4 }),
            frameRate: 10,
            repeat: -1
        });
    }

    function fire(tank, that, isEnemy = false) {
        let fireball = that.physics.add.image(tank.x, tank.y, "fireball");
        fireball.angle = tank.angle;
        let fireDir = fireball.angle;
        if (fireDir == 0) fireball.setVelocityY(0 - fireSpeed);
        if (fireDir == 90) fireball.setVelocityX(fireSpeed);
        if (fireDir == -180) fireball.setVelocityY(fireSpeed);
        if (fireDir == -90) fireball.setVelocityX(0 - fireSpeed);

        that.physics.add.collider(fireball, walls, hitWall, null, that);
        function hitWall(fireball, wall) {
            fireball.destroy();
        }

        if (!isEnemy) {
            that.physics.add.collider(fireball, enemies, hitEnemy, null, that);
            function hitEnemy(fireball, enemy) {
                fireball.destroy();
                enemy.destroy();
            }
        }
    }

    function update() {

        let isDown = move.down.isDown;
        let isUp = move.up.isDown;
        let isLeft = move.left.isDown;
        let isRight = move.right.isDown;
        let isNoOne = !isDown && !isUp && !isLeft && !isRight;
        let isOnlyDown = isDown && !isUp && !isLeft && !isRight;
        let isOnlyUp = isUp && !isDown && !isLeft && !isRight;
        let isOnlyLeft = isLeft && !isUp && !isDown && !isRight;
        let isOnlyRight = isRight && !isUp && !isLeft && !isDown;

        enemies.getChildren().forEach((enemy) => {
            if (Math.random() <= 0.01) fire(enemy, this, true);
            if (Math.random() <= 0.1) {
                let r = Math.random();
                enemy.setVelocity(0, 0);
                if (r <= 0.25) {
                    enemy.angle = 90;
                    enemy.setVelocityX(moveSpeed);
                } else if (r > 0.25 && r <= 0.5) {
                    enemy.angle = 270;
                    enemy.setVelocityX(0 - moveSpeed);
                } else if (r > 0.5 && r <= 0.75) {
                    enemy.angle = 180;
                    enemy.setVelocityY(moveSpeed);
                } else {
                    enemy.angle = 0;
                    enemy.setVelocityY(0 - moveSpeed);
                }
            }
        });

        if (Phaser.Input.Keyboard.JustDown(spacebar)) {
            fire(tank, this);
        }

        if (isNoOne) {
            tank.anims.stop("move");
            tank.setVelocityX(0);
            tank.setVelocityY(0);
        }

        if (isOnlyDown || isOnlyUp || isOnlyLeft || isOnlyRight) {
            tank.setVelocityX(0);
            tank.setVelocityY(0);
            tank.anims.play("move", true);

            if (isLeft) {
                tank.setVelocityX(0 - moveSpeed);
                tank.angle = 270;
            }
            if (isRight) {
                tank.setVelocityX(moveSpeed);
                tank.angle = 90;
            }
            if (isUp) {
                tank.setVelocityY(0 - moveSpeed);
                tank.angle = 0;
            }
            if (isDown) {
                tank.setVelocityY(moveSpeed);
                tank.angle = 180;
            }
        }
    }
    </script>

</body>
</html>
