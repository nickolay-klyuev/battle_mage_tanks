<!DOCTYPE html>
<html>
<head>
    <script src="./scripts/phaser.js"></script>
    <script src="./scripts/fire.js"></script>
    <script src="./scripts/buttonsCollider.js"></script>
    <style>
        body {
            text-align: center;
        }
        canvas {
            display: inline-block;
        }
    </style>
</head>
<body>

    <script>
    let config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        backgroundColor: "#72edd0",
        physics: {
            default: "arcade",
            arcade: {
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    let game = new Phaser.Game(config);

    let walls;
    let tank;
    let move;
    let spacebar;
    let enter;
    let moveSpeed = 100;
    let playerMoveSpeed = 200;
    let playerDamage = 30;
    let fireSpeed = 300;
    let gameOver = false;
    let hpValue = 100;
    let hpText;
    let hpBar;
    let hpWidth = 30;
    let enemies;

    let simpleEnemy = {
        damage: 20
    }

    function preload() {
        this.load.spritesheet("tank", "./sprites/tank-sprite.png", {frameWidth: 26, frameHeight: 32});
        this.load.image("350_32_block", "./sprites/350_32_block.png");
        this.load.image("400_32_block", "./sprites/400_32_block.png");
        this.load.image("32_184_block", "./sprites/32_184_block.png");
        this.load.image("750_32_block", "./sprites/750_32_block.png");
        this.load.image("50_32_block_1", "./sprites/50_32_block_1.png");
        this.load.image("32_184_block_2", "./sprites/32_184_block_2.png");
        this.load.image("50_32_block_3", "./sprites/50_32_block_3.png");
        this.load.image("button_1", "./sprites/button_1.png");
        this.load.image("button_1_active", "./sprites/button_1_active.png");
        this.load.image("button_2", "./sprites/button_2.png");
        this.load.image("button_2_active", "./sprites/button_2_active.png");
        this.load.image("button_3", "./sprites/button_3.png");
        this.load.image("button_3_active", "./sprites/button_3_active.png");
        this.load.image("enemy", "./sprites/enemy.png");
        this.load.image("fireball", "./sprites/fireball.png");
    }

    function create() {
        tank = this.physics.add.sprite(100, 1700, "tank");

        //camera
        this.cameras.main.setBounds(0, 0, 800, 600 * 3);
        this.cameras.main.startFollow(tank, true);
        this.physics.world.setBounds(0, 0, 800, 600 * 3);

        hpBar = this.add.line(tank.x, tank.y, 0, 20, hpWidth, 20, "0x1f8f00");
        tank.setCollideWorldBounds(true);
        enemies = this.physics.add.group({
            key: "enemy",
            repeat: 5,
            setXY: {x: 100, y: 400, stepX: 50},
            collideWorldBounds: true
        });
        enemies.getChildren().forEach((enemy, i) => {
            enemy.hpBar = this.add.line(enemy.x, enemy.y, 0, 20, hpWidth, 20, "0x870000");
            enemy.hpValue = 100;
        });

        move = this.input.keyboard.createCursorKeys();
        spacebar = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
        enter = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);

        hpText = this.add.text(700, 550, `Hp: ${hpValue}`, { fontSize: '15px', fill: '#000000' }).setScrollFactor(0);

        //buttons
        let button_1 = this.physics.add.sprite(350, 1700, "button_1");
        let button_2 = this.physics.add.sprite(700, 1500, "button_2");
        let button_3 = this.physics.add.sprite(700, 1700, "button_3");

        //walls
        walls = this.physics.add.staticGroup();
        walls.create(175, 1600, "350_32_block");
        walls.create(600, 1600, "400_32_block");
        walls.create(600, 1500, "32_184_block");
        walls.create(425, 1300, "750_32_block");
        walls.create(375, 1600, "50_32_block_1");
        walls.create(450, 1708, "32_184_block_2");
        walls.create(25, 1300, "50_32_block_3");

        this.physics.add.collider(tank, walls);
        this.physics.add.collider(enemies, walls);
        this.physics.add.collider(enemies, enemies);
        this.physics.add.collider(tank, enemies);
        this.physics.add.collider(tank, button_1, (tank, btn) => { buttonsCollider(tank, btn, "button_1_active", "block_1", this); });
        this.physics.add.collider(tank, button_2, (tank, btn) => { buttonsCollider(tank, btn, "button_2_active", "block_2", this); });
        this.physics.add.collider(tank, button_3, (tank, btn) => { buttonsCollider(tank, btn, "button_3_active", "block_3", this); });

        this.anims.create({
            key: 'move',
            frames: this.anims.generateFrameNumbers('tank', { start: 0, end: 4 }),
            frameRate: 10,
            repeat: -1
        });
    }

    function update() {
        let isSpace = Phaser.Input.Keyboard.JustDown(spacebar);
        let isEnter = Phaser.Input.Keyboard.JustDown(enter);

        if (hpValue <= 0) gameOver = true;

        hpText.text = `Hp: ${hpValue}`;
        hpBar.x = tank.x;
        hpBar.y = tank.y;
        hpBar.displayWidth = (hpValue * hpWidth) / 100;

        enemies.getChildren().forEach((enemy) => {
            enemy.hpBar.x = enemy.x;
            enemy.hpBar.y = enemy.y;
            enemy.hpBar.displayWidth = (enemy.hpValue * hpWidth) / 100;
            if (enemy.hpValue <= 0) {
                enemy.hpBar.destroy();
                enemy.destroy();
            }
        });

        if (gameOver) {
            this.add.text(300, 250, 'Game Over', { fontSize: '15px', fill: '#000000' }).setScrollFactor(0);
            this.add.text(300, 270, 'Press ENTER to Restart', { fontSize: '15px', fill: '#000000' }).setScrollFactor(0);
            hpBar.destroy();
            tank.destroy();
            this.physics.pause();
            if (isEnter) {
                gameOver = false;
                hpValue = 100;
                this.scene.restart();
            }
        } else if (enemies.getChildren().length == 0) {
            this.add.text(300, 250, 'You are winner', { fontSize: '20px', fill: '#000000' }).setScrollFactor(0);
            this.add.text(300, 270, 'Press ENTER to Restart', { fontSize: '15px', fill: '#000000' }).setScrollFactor(0);
            this.physics.pause();
            if (isEnter) this.scene.restart();
        } else {
            let isDown = move.down.isDown;
            let isUp = move.up.isDown;
            let isLeft = move.left.isDown;
            let isRight = move.right.isDown;
            let isNoOne = !isDown && !isUp && !isLeft && !isRight;
            let isOnlyDown = isDown && !isUp && !isLeft && !isRight;
            let isOnlyUp = isUp && !isDown && !isLeft && !isRight;
            let isOnlyLeft = isLeft && !isUp && !isDown && !isRight;
            let isOnlyRight = isRight && !isUp && !isLeft && !isDown;

            enemies.getChildren().forEach((enemy) => {
                if (Math.random() <= 0.01) fire(enemy, this, true);
                if (Math.random() <= 0.1) {
                    let r = Math.random();
                    enemy.setVelocity(0, 0);
                    if (r <= 0.25) {
                        enemy.angle = 90;
                        enemy.setVelocityX(moveSpeed);
                    } else if (r > 0.25 && r <= 0.5) {
                        enemy.angle = 270;
                        enemy.setVelocityX(0 - moveSpeed);
                    } else if (r > 0.5 && r <= 0.75) {
                        enemy.angle = 180;
                        enemy.setVelocityY(moveSpeed);
                    } else {
                        enemy.angle = 0;
                        enemy.setVelocityY(0 - moveSpeed);
                    }
                }
            });

            if (isSpace) {
                fire(tank, this);
            }

            if (isNoOne) {
                tank.anims.stop("move");
                tank.setVelocityX(0);
                tank.setVelocityY(0);
            }

            if (isOnlyDown || isOnlyUp || isOnlyLeft || isOnlyRight) {
                tank.setVelocityX(0);
                tank.setVelocityY(0);
                tank.anims.play("move", true);

                if (isLeft) {
                    tank.setVelocityX(0 - playerMoveSpeed);
                    tank.angle = 270;
                }
                if (isRight) {
                    tank.setVelocityX(playerMoveSpeed);
                    tank.angle = 90;
                }
                if (isUp) {
                    tank.setVelocityY(0 - playerMoveSpeed);
                    tank.angle = 0;
                }
                if (isDown) {
                    tank.setVelocityY(playerMoveSpeed);
                    tank.angle = 180;
                }
            }
        }
    }
    </script>

</body>
</html>
